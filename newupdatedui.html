<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Maintenance System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }

        .section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .chat-area {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: 20px;
        }

        .ai-message {
            background: #f1f8e9;
            margin-right: 20px;
        }

        .equipment-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }

        .equipment-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .equipment-item:last-child {
            border-bottom: none;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            opacity: 0.7;
            pointer-events: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Smart Maintenance System</h1>
            <p>AI-Powered Equipment Diagnostics & Maintenance</p>
            <div id="connectionAlert" style="margin-top: 10px; display: none;">
                <div class="error-message">
                    ‚ö†Ô∏è Cannot connect to API server. Please ensure the backend is running on http://127.0.0.1:5000
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Equipment Management -->
            <div class="section">
                <h3>Equipment Management</h3>
                <div class="form-group">
                    <label>Machine ID</label>
                    <input type="text" id="machineId" placeholder="e.g., PUMP-001">
                </div>
                <div class="form-group">
                    <label>Machine Name</label>
                    <input type="text" id="machineName" placeholder="e.g., Main Water Pump">
                </div>
                <div class="form-group">
                    <label>Machine Type</label>
                    <select id="machineType">
                        <option value="">Select Type</option>
                        <option value="pump">Pump</option>
                        <option value="motor">Motor</option>
                        <option value="compressor">Compressor</option>
                        <option value="fan">Fan</option>
                        <option value="conveyor">Conveyor</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <button onclick="addEquipment()" id="addEquipmentBtn">Add Equipment</button>
                <button onclick="loadEquipment()" id="refreshEquipmentBtn">üîÑ Refresh</button>
                
                <div class="equipment-list" id="equipmentList">
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Loading equipment...
                    </div>
                </div>
            </div>

            <!-- AI Diagnosis -->
            <div class="section">
                <h3>AI Diagnosis Chat</h3>
                <div class="form-group">
                    <label>Select Equipment</label>
                    <select id="diagnosisEquipment">
                        <option value="">Select equipment first</option>
                    </select>
                </div>
                
                <div class="chat-area" id="chatArea">
                    <div class="message ai-message">
                        <strong>AI Assistant:</strong> Hello! I'm ready to help diagnose equipment issues. Please select equipment and describe the problem you're experiencing.
                    </div>
                </div>
                
                <div class="form-group">
                    <textarea id="userInput" placeholder="Describe the issue (e.g., unusual noise, vibration, overheating...)" rows="3"></textarea>
                </div>
                <button onclick="sendMessage()" class="btn-success" id="sendBtn">Send Message</button>
                <button onclick="clearChat()" class="btn-warning">Clear Chat</button>
                <button onclick="createSession()" id="sessionBtn">üÜï New Session</button>
            </div>

            <!-- Quick Actions -->
            <div class="section">
                <h3>Quick Actions</h3>
                <button onclick="testConnection()">üîó Test API Connection</button>
                <button onclick="runDiagnostic()">üîç Run Full Diagnostic</button>
                <button onclick="generateReport()">üìä Generate Report</button>
                <button onclick="viewHistory()">üìã View History</button>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label>Upload Document</label>
                    <input type="file" id="fileUpload" accept=".pdf,.docx,.txt">
                    <button onclick="uploadDocument()" style="margin-top: 10px;" id="uploadBtn">Upload</button>
                </div>
            </div>

            <!-- System Status -->
            <div class="section">
                <h3>System Status</h3>
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>AI Provider:</span>
                    <select id="aiProvider" onchange="changeProvider()">
                        <option value="auto">Auto (Best Available)</option>
                        <option value="groq">Groq</option>
                        <option value="gemini">Gemini</option>
                        <option value="local">Local Fallback</option>
                    </select>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>API Status:</span>
                    <span class="status-indicator status-warning" id="apiStatus">Checking...</span>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                    <span>Current Session:</span>
                    <span id="currentSession">None</span>
                </div>
                
                <button onclick="checkHealth()">ü©∫ Health Check</button>
                <button onclick="getProviderStatus()">üì° Provider Status</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://127.0.0.1:5000/api';
        
        // State management
        let equipment = [];
        let currentSessionId = null;
        let isConnected = false;

        // Utility functions
        function showError(message) {
            console.error('Error:', message);
            // You could show a toast notification here
        }

        function showSuccess(message) {
            console.log('Success:', message);
            // You could show a toast notification here
        }

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error(`API call failed: ${endpoint}`, error);
                if (!isConnected) {
                    document.getElementById('connectionAlert').style.display = 'block';
                }
                throw error;
            }
        }

        // Equipment Management
        async function loadEquipment() {
            try {
                const response = await apiCall('/equipment');
                equipment = response.equipment || [];
                updateEquipmentList();
                updateDiagnosisSelect();
                isConnected = true;
                document.getElementById('connectionAlert').style.display = 'none';
                updateAPIStatus('Connected', 'active');
            } catch (error) {
                showError('Failed to load equipment');
                updateAPIStatus('Disconnected', 'error');
            }
        }

        async function addEquipment() {
            const id = document.getElementById('machineId').value.trim();
            const name = document.getElementById('machineName').value.trim();
            const type = document.getElementById('machineType').value;

            if (!id || !name || !type) {
                alert('Please fill all fields');
                return;
            }

            const btn = document.getElementById('addEquipmentBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';

            try {
                await apiCall('/equipment', {
                    method: 'POST',
                    body: JSON.stringify({ id, name, type })
                });

                showSuccess('Equipment added successfully');
                
                // Clear form
                document.getElementById('machineId').value = '';
                document.getElementById('machineName').value = '';
                document.getElementById('machineType').value = '';
                
                // Reload equipment list
                await loadEquipment();
            } catch (error) {
                showError('Failed to add equipment: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Equipment';
            }
        }

        function updateEquipmentList() {
            const list = document.getElementById('equipmentList');
            
            if (equipment.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No equipment found</div>';
                return;
            }

            list.innerHTML = equipment.map(eq => `
                <div class="equipment-item">
                    <div>
                        <strong>${eq.id}</strong><br>
                        <small>${eq.name} (${eq.type})</small>
                    </div>
                    <span class="status-indicator status-active">Active</span>
                </div>
            `).join('');
        }

        function updateDiagnosisSelect() {
            const select = document.getElementById('diagnosisEquipment');
            
            if (equipment.length === 0) {
                select.innerHTML = '<option value="">No equipment available</option>';
                return;
            }

            select.innerHTML = '<option value="">Select equipment</option>' + 
                equipment.map(eq => `<option value="${eq.id}">${eq.id} - ${eq.name}</option>`).join('');
        }

        // Session Management
        async function createSession() {
            const equipmentId = document.getElementById('diagnosisEquipment').value;
            
            if (!equipmentId) {
                alert('Please select equipment first');
                return;
            }

            const btn = document.getElementById('sessionBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const response = await apiCall('/sessions', {
                    method: 'POST',
                    body: JSON.stringify({ equipment_id: equipmentId })
                });

                currentSessionId = response.session_id;
                document.getElementById('currentSession').textContent = currentSessionId.substring(0, 8) + '...';
                
                addToChatArea('ai-message', 'AI Assistant', `New diagnosis session created for ${equipmentId}. How can I help you today?`);
                showSuccess('New session created successfully');
            } catch (error) {
                showError('Failed to create session: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üÜï New Session';
            }
        }

        // Chat Functions
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            const equipmentId = document.getElementById('diagnosisEquipment').value;
            
            if (!message) return;
            
            if (!equipmentId) {
                alert('Please select equipment first');
                return;
            }

            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            // Add user message to chat
            addToChatArea('user-message', 'You', message);
            input.value = '';

            try {
                // Add thinking message
                const thinkingDiv = addToChatArea('ai-message', 'AI Assistant', 'ü§ñ Analyzing... Please wait.');
                
                const response = await apiCall('/diagnose', {
                    method: 'POST',
                    body: JSON.stringify({
                        message: message,
                        equipment_id: equipmentId,
                        session_id: currentSessionId
                    })
                });

                // Remove thinking message
                thinkingDiv.remove();
                
                // Add AI response
                addToChatArea('ai-message', 'AI Assistant', response.response);
                
            } catch (error) {
                // Remove thinking message if it exists
                const thinkingMsg = document.querySelector('.message:last-child');
                if (thinkingMsg && thinkingMsg.textContent.includes('Analyzing')) {
                    thinkingMsg.remove();
                }
                
                addToChatArea('ai-message', 'AI Assistant', '‚ùå Sorry, I encountered an error processing your request. Please try again or check the API connection.');
                showError('Failed to get AI response: ' + error.message);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send Message';
            }
        }

        function addToChatArea(className, sender, message) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.innerHTML = `<strong>${sender}:</strong> ${message}`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
            return messageDiv;
        }

        function clearChat() {
            document.getElementById('chatArea').innerHTML = `
                <div class="message ai-message">
                    <strong>AI Assistant:</strong> Chat cleared. How can I help you with equipment diagnosis?
                </div>
            `;
            currentSessionId = null;
            document.getElementById('currentSession').textContent = 'None';
        }

        // File Upload
        async function uploadDocument() {
            const fileInput = document.getElementById('fileUpload');
            const equipmentId = document.getElementById('diagnosisEquipment').value;
            const file = fileInput.files[0];

            if (!file) {
                alert('Please select a file');
                return;
            }

            if (!equipmentId) {
                alert('Please select equipment first');
                return;
            }

            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            btn.textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('equipment_id', equipmentId);

                const response = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.statusText}`);
                }

                const result = await response.json();
                showSuccess(`Document "${file.name}" uploaded successfully!`);
                addToChatArea('ai-message', 'System', `üìÑ Document "${file.name}" has been uploaded and processed. You can now ask questions about its content.`);
                
                fileInput.value = '';
            } catch (error) {
                showError('Failed to upload document: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Upload';
            }
        }

        // Provider Management
        async function changeProvider() {
            const provider = document.getElementById('aiProvider').value;
            
            try {
                await apiCall('/providers', {
                    method: 'POST',
                    body: JSON.stringify({ provider })
                });
                showSuccess(`AI provider changed to: ${provider}`);
            } catch (error) {
                showError('Failed to change provider: ' + error.message);
            }
        }

        async function getProviderStatus() {
            try {
                const response = await apiCall('/providers');
                
                let statusText = `Current Provider: ${response.current_provider}\n\nProvider Status:\n`;
                Object.entries(response.providers).forEach(([name, info]) => {
                    statusText += `‚Ä¢ ${name}: ${info.configured ? '‚úÖ Configured' : '‚ùå Not configured'} - ${info.description}\n`;
                });
                
                alert(statusText);
            } catch (error) {
                showError('Failed to get provider status: ' + error.message);
            }
        }

        // System Status
        async function checkHealth() {
            try {
                const response = await apiCall('/health');
                
                let healthText = `System Status: ${response.status}\nTimestamp: ${new Date(response.timestamp).toLocaleString()}\n\nProviders:\n`;
                Object.entries(response.providers).forEach(([name, status]) => {
                    healthText += `‚Ä¢ ${name}: ${status ? '‚úÖ Available' : '‚ùå Unavailable'}\n`;
                });
                
                alert(healthText);
                updateAPIStatus('Connected', 'active');
            } catch (error) {
                showError('Health check failed: ' + error.message);
                updateAPIStatus('Disconnected', 'error');
            }
        }

        async function testConnection() {
            try {
                updateAPIStatus('Testing...', 'warning');
                const response = await apiCall('/test', { method: 'POST' });
                
                alert(`Connection test successful!\nProvider: ${response.provider}\nResponse: ${response.response}`);
                updateAPIStatus('Connected', 'active');
            } catch (error) {
                showError('Connection test failed: ' + error.message);
                updateAPIStatus('Disconnected', 'error');
            }
        }

        function updateAPIStatus(text, status) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.textContent = text;
            statusEl.className = `status-indicator status-${status}`;
        }

        // Quick Actions (placeholder implementations)
        function runDiagnostic() {
            alert('Full diagnostic feature would integrate with sensor data and perform comprehensive analysis.');
        }

        function generateReport() {
            alert('Report generation would compile all findings into a downloadable PDF report.');
        }

        function viewHistory() {
            alert('History view would display past diagnoses and trends for selected equipment.');
        }

        // Enter key support for chat
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize the application
        window.addEventListener('load', function() {
            loadEquipment();
            checkHealth();
        });
    </script>
</body>
</html>